{"ts":1340800851761,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"\n//setup Dependencies\nvar connect = require('connect')\n    , express = require('express')\n    , io = require('socket.io')\n    ,redis = require('socket.io/node_modules/redis')\n    , port = (process.env.PORT || 8081)\n    ,nohm = require('nohm').Nohm;\n\n//Setup Express\nvar server = express.createServer();\nserver.configure(function(){\n    server.set('views', __dirname + '/views');\n    server.set('view options', { layout: false });\n    server.use(connect.bodyParser());\n    server.use(express.cookieParser());\n    server.use(express.session({ secret: \"shhhhhhhhh!\"}));    \n    server.use(connect.static(__dirname + '/static'));\n    server.use(server.router);\n    server.use(express.errorHandler({ dumpExceptions: true, showStack: true }));\n});\n//Redis. we use the io redis.\n//redis://guillaume:9ffd430d2e0d3a45b44ae987d2bb7ede@koi.redistogo.com:9337/\n//pass=9ffd430d2e0d3a45b44ae987d2bb7ede\nvar redisClient = redis.createClient('9337','koi.redistogo.com');\nredisClient.auth('9ffd430d2e0d3a45b44ae987d2bb7ede',redis.print);\nnohm.setClient(redis);\nnohm.model('Gift', {\n    properties: {\n      name: {\n        type: 'string',\n        unique: true,\n        validations: [\n          'notEmpty'\n        ]\n      },\n      description: {\n        type: 'string',\n        unique: true,\n        validations: [\n          'notEmpty'\n        ]\n      },\n      contact: {\n        type: 'string',\n        defaultValue: 'Djark, 06 00 00 00 00, x@x.com',\n        validations: [\n          'notEmpty'\n        ]\n      },\n      thumbnail: {\n        type: 'string',\n        defaultValue: '/img/gift-thumnail.jpg',\n        validations: [\n          'notEmpty'\n        ]\n      },      \n      online:{\n        type: 'boolean',\n        defaultValue: true,\n        index: true\n      },\n      givers:{\n        type: 'json',\n        defaultValue: {list:[]}        \n      }\n      \n    },\n    methods: {\n        // gv is {gname,gcontact,gmessage,gdate}\n      give: function (gv) {  \n          if(gv)\n            this.p('givers').list.push=gv;        \n          return gv\n      }\n    },\n    idGenerator: 'increment'    \n  });\n  \n  var gift = nohm.factory('Gift');\n  gift.p({\n    name: 'Mark',\n    description: 'mark@example.com',\n    country: 'Mexico',\n    visits: 1\n  });\n  gift.save(function (err) {\n    if (err === 'invalid') {\n      console.log('properties were invalid: ', gift.errors);\n    } else if (err) {\n      console.log(err); // database or unknown error\n    } else {\n      console.log('saved gift! :-)');\n     /* gift.remove(function (err) {\n        if (err) {\n          console.log(err); // database or unknown error\n        } else {\n          console.log('successfully removed gift');\n        }\n      });*/\n    }\n  });\n  \n//setup the errors\nserver.error(function(err, req, res, next){\n    if (err instanceof NotFound) {\n        res.render('404.jade', { locals: { \n                  title : '404 - Not Found'\n                 ,description: ''\n                 ,author: 'Yawo Guillaume Kpotufe'\n                 ,analyticssiteid: 'UA-32864937-1' \n                },status: 404 });\n    } else {\n        res.render('500.jade', { locals: { \n                  title : 'The Server Encountered an Error'\n                 ,description: ''\n                 ,author: 'Yawo Guillaume Kpotufe'\n                 ,analyticssiteid: 'UA-32864937-1'\n                 ,error: err \n                },status: 500 });\n    }\n});\nserver.listen( port);\n\n//Setup Socket.IO\nvar io = io.listen(server);\nio.sockets.on('connection', function(socket){\n  console.log('Client Connected');\n  socket.on('message', function(data){\n    socket.broadcast.emit('server_message',data);\n    socket.emit('server_message',data);\n  });\n  socket.on('disconnect', function(){\n    console.log('Client Disconnected.');\n  });\n});\n\n\n///////////////////////////////////////////\n//              Routes                   //\n///////////////////////////////////////////\n\n/////// ADD ALL YOUR ROUTES HERE  /////////\n\nserver.get('/', function(req,res){\n  res.render('index.jade', {\n    locals : { \n              title : 'Mariage Djark & Lydie'\n             ,description: 'Mariage Djark & Lydie'\n             ,author: 'Yawo Guillaume Kpotufe'\n             ,analyticssiteid: 'UA-32864937-1' \n            }\n  });\n});\n\n\n//A Route for Creating a 500 Error (Useful to keep around)\nserver.get('/500', function(req, res){\n    throw new Error('This is a 500 Error');\n});\n\n//The 404 Route (ALWAYS Keep this as the last route)\nserver.get('/*', function(req, res){\n    throw new NotFound;\n});\n\nfunction NotFound(msg){\n    this.name = 'NotFound';\n    Error.call(this, msg);\n    Error.captureStackTrace(this, arguments.callee);\n}\n\n\nconsole.log('Listening on http://0.0.0.0:' + port );\n"]],"start1":0,"start2":0,"length1":0,"length2":4690}]],"length":4690}
{"contributors":[],"silentsave":false,"ts":1340801246231,"patch":[[{"diffs":[[0,"re('"],[-1,"socket.io/node_modules/"],[0,"redi"]],"start1":140,"start2":140,"length1":31,"length2":8}]],"length":4667,"saved":false}
{"ts":1340801420133,"patch":[[{"diffs":[[0,"print);\n"],[1,"//redisClient.on('connection'\n"],[0,"nohm.set"]],"start1":990,"start2":990,"length1":16,"length2":46}]],"length":4697,"saved":false}
{"ts":1340801479223,"patch":[[{"diffs":[[0,"equire('"],[1,"nohm/node_modules/"],[0,"redis')\n"]],"start1":136,"start2":136,"length1":16,"length2":34},{"diffs":[[0,"t);\n"],[-1,"//redisClient.on('connection'\n"],[0,"nohm"]],"start1":1012,"start2":1012,"length1":38,"length2":8}]],"length":4685,"saved":false}
{"ts":1340801572077,"patch":[[{"diffs":[[0,"re('nohm"],[1,"d"],[0,"/node_mo"]],"start1":140,"start2":140,"length1":16,"length2":17}]],"length":4686,"saved":false}
{"ts":1340801578309,"patch":[[{"diffs":[[0,"re('nohm"],[-1,"d"],[0,"/node_mo"]],"start1":140,"start2":140,"length1":17,"length2":16}]],"length":4685,"saved":false}
{"ts":1340801615892,"patch":[[{"diffs":[[0,"nt(redis"],[1,"Client"],[0,");\nnohm."]],"start1":1028,"start2":1028,"length1":16,"length2":22}]],"length":4691,"saved":false}
{"contributors":[],"silentsave":true,"ts":1341233454240,"patch":[[{"diffs":[[0,"re('"],[-1,"nohm/node_modules/"],[0,""],[1,""],[0,"redi"]],"start1":140,"start2":140,"length1":26,"length2":8},{"diffs":[[0,"dis.print);\n"],[1,"redisClient.on('connect',function(){\n /* var gift = new GiftModel();\n  gift.p({\n    name: 'Moulinex3'+Math.random(),\n    description: 'mark@example.com',\n    \n  });\n  gift.save(function (err) {\n    if (err === 'invalid') {\n      console.log('properties were invalid: ', gift.errors);\n    } else if (err) {\n      console.log(err); // database or unknown error\n    } else {\n      console.log('saved gift! :-)',gift);\n      \n    }  \n  });*/\n  \n});\n"],[0,"nohm.setClie"]],"start1":986,"start2":986,"length1":24,"length2":469},{"diffs":[[0,"lient);\n"],[1,"var GiftModel = "],[0,"nohm.mod"]],"start1":1464,"start2":1464,"length1":16,"length2":32},{"diffs":[[0,"string',"],[-1,"\n"],[0,"        "],[-1,"unique: true,"],[0,"\n       "]],"start1":1686,"start2":1686,"length1":38,"length2":24},{"diffs":[[0," is "],[-1,"{gname,gcontact,g"],[1,"[contact,telMail,"],[0,"message,"],[-1,"g"],[0,"date"],[-1,"}"],[1,"Creation,dateLivraison];"],[0,"\n   "]],"start1":2310,"start2":2310,"length1":39,"length2":61},{"diffs":[[0,"\n  \n"],[-1,"  var gift = nohm.factory('Gift');\n  gift.p({\n    name: 'Mark',\n    description: 'mark@example.com',\n    country: 'Mexico',\n    visits: 1\n  });\n  gift.save(function (err) {\n    if (err === 'invalid') {\n      console.log('properties were invalid: ', gift.errors);\n    } else if (err) {\n      console.log(err); // database or unknown error\n    } else {\n      console.log('saved gift! :-)');\n     /* gift.remove(function (err) {\n        if (err) {\n          console.log(err); // database or unknown error\n        } else {\n          console.log('successfully removed gift');\n        }\n      });*/\n    }\n  });\n  \n"],[0,"//se"]],"start1":2539,"start2":2539,"length1":616,"length2":8},{"diffs":[[0,"//\n\n"],[-1,"server.get('/', function(req,res){\n  res.render('index.jade', {\n"],[1,"function serveGift(req,res,vw){\n    GiftModel.find(function(err,ids){\n      if(err){\n         console.log(\"Error getting gifts\",err);     \n         return res.render(vw, {\n            locals : { \n              title : 'Mariage Djark & Lydie'\n             ,description: 'Mariage Djark & Lydie'\n             ,author: 'Yawo Guillaume Kpotufe'\n             ,analyticssiteid: 'UA-32864937-1'             \n            },gifts:[]\n         });\n      }else{\n        var gifts = [];\n        var len = ids.length;\n        var count = 0;\n        if (len === 0) {\n          return res.render(vw, {\n            locals : { \n              title : 'Mariage Djark & Lydie'\n             ,description: 'Mariage Djark & Lydie'\n             ,author: 'Yawo Guillaume Kpotufe'\n             ,analyticssiteid: 'UA-32864937-1'             \n            },gifts:[]\n         });\n        }\n        ids.forEach(function (id) {\n          var gift = new GiftModel();\n          gift.load(id, function (err, props) {\n            if (err) {\n              return next(err);\n            }\n            //gift.remove();\n            gifts.push(props);\n            if (++count === len) {\n             return res.render(vw, {\n            "],[0,"    "]],"start1":3777,"start2":3777,"length1":72,"length2":1202},{"diffs":[[0,"    locals : { \n"],[1,"    "],[0,"              ti"]],"start1":4975,"start2":4975,"length1":32,"length2":36},{"diffs":[[0,"e'\n             "],[1," "],[1,"   "],[0,",description: 'M"]],"start1":5038,"start2":5038,"length1":32,"length2":36},{"diffs":[[0,"e'\n             "],[1,"    "],[0,",author: 'Yawo G"]],"start1":5093,"start2":5093,"length1":32,"length2":36},{"diffs":[[0,"e'\n             "],[1,"  "],[1,"  "],[0,",analyticssiteid"]],"start1":5144,"start2":5144,"length1":32,"length2":36},{"diffs":[[0,"-1' "],[-1,"\n            }\n  });\n});\n"],[1,"            \n                },gifts:gifts\n              });\n            }\n          });\n        });\n            \n          }\n      \n  });\n}\n\nfunction deleteAll(){\n    GiftModel.find(function(err,ids){\n      if(err){\n         console.log(\"Error getting gifts\",err);     \n      }else{\n        \n        var len = ids.length;\n        var count = 0;\n        if (len === 0) {\n        }\n        ids.forEach(function (id) {\n          var gift = new GiftModel();\n          gift.load(id, function (err, props) {\n            if (err) {\n              console.log(err);\n            }\n            gift.remove();\n          });\n        });            \n    }      \n  });\n}\n\n\nserver.get('/djarkrajd', function(req,res){\n  return serveGift(req,res,'admin.jade');\n});\n\n\nserver.get('/', function(req,res){\n  return serveGift(req,res,'index.jade');\n});\n\nfunction updateGift(gift,thumbnail,name,description,contact,online){\n    gift.p('thumbnail',thumbnail);\n    gift.p('name',name);\n    gift.p('description',description);\n    gift.p('contact',contact);\n    gift.p('online',online);\n    gift.save(function (err) {\n        if (err === 'invalid') {\n          console.log('properties were invalid: ', gift.errors);\n        } else if (err) {\n          console.log(err); // database or unknown error\n        } else {\n          console.log('saved gift! :-)',name);\n          \n        }  \n    });\n}\n\nserver.post('/updateGift',function(req,res){\n    var id,thumbnail,name,description,contact,online;\n    var gift=new GiftModel();\n    gift.load(id, function (err,props) {\n        if(err==='not found'){            \n            updateGift(gift,thumbnail,name,description,contact,online);\n            res.send('SUCCESS');\n        }else if(err){\n            console.log(\"updateGift Error\",id,err);\n            res.send('FAILURE');\n        }else{\n            updateGift(gift,thumbnail,name,description,contact,online);\n            res.send('SUCCESS');\n        }\n    });\n});\n\n\nserver.post('/addGiftGiver',function(req,res){\n    var id=req.body.id,contact=req.body.contact,telMail=req.body.tel,message=req.body.message,dateCreation = new Date();\n    var gift=new GiftModel();\n    gift.load(id, function (erro,props) {\n        if(erro){\n            console.log(\"addGiftGiver Error\",id,erro);\n            res.send('FAILURE');\n        }else{\n            gift.give([contact,telMail,message,dateCreation]);\n            gift.save(function (err) {\n                if (err === 'invalid') {\n                  console.log('addGiftGiver:properties were invalid: ', gift.errors);\n                  res.send('FAILURE');\n                } else if (err) {\n                  console.log('addGiftGiver:Database err',err); // database or unknown error\n                  res.send('FAILURE');\n                } else {\n                  console.log('addGiftGiver:saved gift! :-)');                  \n                  res.send('SUCCESS');\n                }\n            });\n        }\n    });\n});\n\nserver.post('/deleteGift',function(req,res){\n     var id;\n     var gift = new GiftModel();\n     gift.id=id;\n     gift.remove({},function(err){\n         if(err) {\n             console.log(\"deleteGift Error\",id,err);\n             res.send('FAILURE');\n         }else{\n            console.log(\"deleteGift Error\",id,err);\n            res.send('FAILURE');\n         }\n     });\n     \n});\n\nserver.post('/djarkkrajd/deleteAll',function(req,res){\n    deleteAll();\n    res.send(\"Done<br/> <a href='/'>Home</a>\");\n});"],[0,"\n\n//"]],"start1":5194,"start2":5194,"length1":33,"length2":3450}]],"length":9097,"saved":false}
{"ts":1341233457166,"patch":[[{"diffs":[[0,"   \n      }else{"],[-1,"\n"],[0,"        \n       "]],"start1":5465,"start2":5465,"length1":33,"length2":32}]],"length":9096,"saved":false}
